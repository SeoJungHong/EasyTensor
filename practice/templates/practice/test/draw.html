{% extends 'practice/base_test.html' %}
{% load staticfiles %}

{% block frame %}
<h3>Using your own data</h3>
<div class="col-md-5">
  <p>Draw a number</p>
  <p>
    <canvas id="input" width="280" height="280" style="border:solid 2px"></canvas>
  </p>
  <p>
    <button id="clear" class="btn btn-default">clear</button>
    <button id="set" class="btn btn-default">set</button>
  </p>
</div>
<div class="col-md-7">
  <table id="result" class="table">
    <tr>
      <th scope="col"></th>
      <th scope="col">Your Model</th>
      <th scope="col">Reference Model(99%)</th>
    </tr>
    {% for key in keys %}
      <tr id="data">
        <th scope="row">{{ key }}</th>
        <td id="original"></td>
        <td id="reference"></td>
      </tr>
    {% endfor %}
  </table>
</div>
<script>
  var eventObject = {
    drawing: false,
    x: 0,
    y: 0
  };
  var canvas = document.getElementById('input');
  var context = canvas.getContext("2d");
  var resultData = $('#result').find('#data');
  (function initialize() {
    context.fillStyle = '#FFFFFF';
    context.fillRect(0, 0, canvas.width, canvas.height);
    canvas.addEventListener('mousedown', initDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseout', endDraw);
  })();
  $('#clear').click(function () {
    context.fillStyle = '#FFFFFF';
    context.fillRect(0, 0, canvas.width, canvas.height);
    for (var i = 0; i < 10; i++) {
      resultData.eq(i).find('td').text("");
    }
  });
  $('#set').click(function () {
    getTestImage();
  });
  function getPosition(event) {
    var bounding = canvas.getBoundingClientRect();
    return {
      x: event.clientX - bounding.left,
      y: event.clientY - bounding.top
    };
  }
  function initDraw(event) {
    eventObject.drawing = true;
    var curr = getPosition(event);
    eventObject.x = curr.x;
    eventObject.y = curr.y;
    canvas.style.cursor = 'default';
    context.fillStyle = '#000000';
    context.lineWidth = 15;
    context.lineCap = 'round';
  }
  function draw(event) {
    if (eventObject.drawing) {
      var curr = getPosition(event);
      context.beginPath();
      context.moveTo(eventObject.x, eventObject.y);
      context.lineTo(curr.x, curr.y);
      context.stroke();
      context.closePath();
      eventObject.x = curr.x;
      eventObject.y = curr.y;
    }
  }
  function endDraw(event) {
    eventObject.drawing = false;
    eventObject.x = 0;
    eventObject.y = 0;
  }
  function getTestImage() {
    var inputs = new Array(784).fill(0);
    var data = context.getImageData(0, 0, 280, 280).data;
    var stride = 280 * 4;
    var i, j;
    for (i = 0; i < 280; i++) {
      var y = Math.floor(i / 10);
      var n = i * stride;
      for (j = 0; j < 280; j++) {
        var x = Math.floor(j / 10);
        inputs[y * 28 + x] += (data[n] + data[n + 1] + data[n + 2]) / 3;
        n += 4;
      }
    }
    for (i = 0; i < 28; i++) {
      for (j = 0; j < 28; j++) {
        inputs[i * 28 + j] /= 100;
      }
    }
    input = JSON.stringify(inputs);
    console.log('input: ' + input);
    $.post(
      "/{{ practice_name }}/test/draw_result",
      { image_data: input },
      function (data) {
        for (var i = 0; i < 10; i++) {
          var rounding_original=data.original[i].toFixed(3);
          var rounding_reference=data.reference[i].toFixed(3);
          resultData.eq(i).find('#original').text(rounding_original);
          resultData.eq(i).find('#reference').text(rounding_reference);
        }
      }
    );
  }
</script>
{% endblock frame %}

{% block scripts %}
<script>
  $(document).ready(function() {
    $('.data-end').attr('src','{% static 'practice/images/end_check.png' %}');
    $('.algorithm-end').attr('src','{% static 'practice/images/end_check.png' %}');
    $('.training-middle').attr('src','{% static 'practice/images/middle_check.png' %}');
    $('.training-end').attr('src','{% static 'practice/images/end_check.png' %}');
    $('#test-1').attr('src','{% static 'practice/images/middle_exec.png' %}');
    $('#test-1').parent().next().children().css('font-weight','Bold');
    $('#test-1').parent().next().children().css('font-size','17px');
  });
</script>
{% endblock scripts %}